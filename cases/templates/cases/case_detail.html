{% extends "cases/base.html" %}
{% load cases_tags %}
{% load render_table from django_tables2 %}
{% load django_import_data_tags %}
{% load crispy_forms_tags %}

{% block content %}

{% if case.model_import_attempt %}
    {% make_breadcrumb case %}
{% endif %}

<div id="top"></div>

{% if tables.5.data %}
<div class="jumbotron jumbotron-warning">
    <h2 style="color: red" class="display-4">Case is Missing Data</h2>
    <p class="lead"><span style="color: red">One or more related models failed to import! You will need to manually fix these by editing the Case.</span></p>

    {% render_table tables.5 %}
</div>
{% endif %}

<div class="row">
    <div class="col-auto">
        <h1>Case {{ case.case_num }}</h1>
    </div>

    <div class="col-auto pl-4">
        <div class="row">
            {% include "cases/person_info_inline.html" with case=case %}
        </div>
    </div>

    <div class="col-auto d-print-none pl-4">
        <div>Date Received: {{ case.date_received|default:"None" }}</div>
        <div>Date Completed: {{ case.completed_on|default:"None" }}</div>
    </div>

    <div class="ml-auto col-auto d-print-none">
        <div class="row">
            <div class="col-auto d-print-none">
                <div><a href="{% url 'case_update' case.case_num %}">Edit</a></div>
                <div><a href="{% url 'admin:cases_case_delete' case.id %}"> Delete</a></div>
            </div>

            <div class="col-auto d-print-none">
                <form action="{% url 'duplicate_case' case.case_num %}" method="post">
                    {% csrf_token %}
                    {{ duplicate_case_form.as_p }}
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row pt-3">
    <div class="col-auto">
        <h2 title="Files that have contributed data to this Case or its Facilities">File Info</h2>
        {% if tables.4.data %}
        {% render_table tables.4 %}
        {% else %}
        <p>No external files have contributed data to this Case or its Facilities</p>
        {% endif %}
        <div class="row">
            <div class="col">
                {% info_table case "Case Info" application_info %}
            </div>

            <div class="col">
                {% info_table case "Sugar Grove Info" sgrs_info %}
            </div>

            <div class="col">
                {% info_table case "Case Status" status_info %}
            </div>
        </div>
    </div>
    <div class="col">
        <h2>Comments</h2>
        {% if case.comments %}
        <div style="max-height: 450px; overflow: auto">
        {{ case.comments | linebreaks }}

        </div>
        {% else %}
        <p>No comments</p>
        {% endif %}
    </div>
</div>

<h2 style="display: inline">Facilities ({{tables.0.data|length}})</h2>
{% if tables.0.data %}
<a href="{% url 'case_kml' case.id %}">As KML</a>
<a href="{% url 'facility_index' %}?case={{ case.case_num }}">View in Facilities Index</a>
{% render_table tables.0 %}
{% else %}
<p>No Facilities</p>
{% endif %}

<h2 style="display: inline">Attachments ({{tables.1.data|length}})</h2>
{% if tables.1.data %}
<a href="{% url 'attachment_index' %}?cases={{ case.case_num }}">View in Attachments Index</a>
{% render_table tables.1 %}
{% else %}
<p>No attachments</p>
{% endif %}

{% include "cases/related_cases_info.html" with case=case case_table=tables.2 pcase_table=tables.3 %}

{% if case.import_error_summary %}
<h2>Import Errors</h2>
<p>Map of column headers to list of unique invalid values (values that caused errors)</p>
{{ case.import_error_summary|json|safe }}
{% endif %}

<hr>

{% if unsorted_info %}
<div class="row">
    <div class="col-lg">
        {% info_table case "TODO: Unsorted" unsorted_info %}
    </div>
</div>
{% endif %}

{% endblock %}
